<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MzanziFX Trading Signals</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.1.1/dist/chartjs-chart-financial.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg: #0a0e1a;
            --surface: #131a2e;
            --border: #1e2d4a;
            --accent: #00ff88;
            --danger: #ff3366;
            --warning: #ffaa00;
            --text: #e0e6f0;
            --muted: #7a8aa5;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg);
            color: var(--text);
            overflow: hidden;
        }

        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: rgba(19, 26, 46, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 1000;
        }

        .logo {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.2em;
            font-weight: 700;
            color: var(--accent);
            letter-spacing: 2px;
        }

        .nav-tabs {
            display: flex;
            gap: 5px;
        }

        .nav-tab {
            padding: 8px 16px;
            background: transparent;
            border: none;
            color: var(--muted);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85em;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s;
        }

        .nav-tab:hover { background: var(--surface); color: var(--accent); }
        .nav-tab.active { background: var(--accent); color: var(--bg); }

        .status {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--muted);
            transition: all 0.3s;
        }

        .status-dot.connected { background: var(--accent); animation: pulse 2s infinite; }
        .status-dot.connecting { background: var(--warning); animation: pulse 1s infinite; }
        .status-dot.disconnected { background: var(--danger); }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .main {
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
        }

        .tab-content {
            display: none;
            height: 100%;
            padding: 20px;
            overflow-y: auto;
        }

        .tab-content.active { display: block; }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .index-btns {
            display: flex;
            gap: 8px;
        }

        .index-btn {
            padding: 10px 20px;
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--muted);
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .index-btn:hover { border-color: var(--accent); color: var(--accent); }
        .index-btn.active { background: var(--accent); border-color: var(--accent); color: var(--bg); }

        .chart-wrapper {
            height: calc(100vh - 160px);
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 15px;
            position: relative;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 14, 26, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            z-index: 10;
        }

        .loading-overlay.hidden { display: none; }

        .spinner {
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-text {
            color: var(--accent);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9em;
        }

        #chart { width: 100%; height: 100%; }

        .grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            height: calc(100vh - 100px);
        }

        .panel {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            overflow-y: auto;
        }

        .panel-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.1em;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }

        .signal-box {
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .signal-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .signal-row:last-child { border-bottom: none; }

        .signal-label {
            color: var(--muted);
            font-size: 0.85em;
            font-family: 'JetBrains Mono', monospace;
        }

        .signal-value {
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .signal-value.buy { color: var(--accent); }
        .signal-value.sell { color: var(--danger); }

        .btn-gen {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, var(--accent), #00cc6a);
            border: none;
            border-radius: 8px;
            color: var(--bg);
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            font-size: 1em;
            cursor: pointer;
            margin-top: 15px;
        }

        .btn-gen:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 255, 136, 0.3); }
        .btn-gen:disabled { background: var(--border); cursor: not-allowed; }

        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
            .index-btns { width: 100%; }
            .index-btn { flex: 1; padding: 8px; font-size: 0.75em; }
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="logo">âš¡ MZANZIFX</div>
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('chart-tab')">CHART</button>
            <button class="nav-tab" onclick="switchTab('signals-tab')">SIGNALS</button>
        </div>
        <div class="status">
            <div class="status-dot" id="statusDot"></div>
            <span id="status">CONNECTING...</span>
        </div>
    </div>

    <div class="main">
        <div id="chart-tab" class="tab-content active">
            <div class="controls">
                <div class="index-btns">
                    <button class="index-btn active" data-symbol="R_100">Volatility 100</button>
                    <button class="index-btn" data-symbol="R_75">Volatility 75</button>
                    <button class="index-btn" data-symbol="R_50">Volatility 50</button>
                    <button class="index-btn" data-symbol="R_25">Volatility 25</button>
                </div>
                <div style="color: var(--muted); font-family: 'JetBrains Mono'; font-size: 0.85em;">
                    <span id="idx">Volatility 100</span> | <span id="price">--</span>
                </div>
            </div>
            <div class="chart-wrapper">
                <div class="loading-overlay" id="loadingOverlay">
                    <div class="spinner"></div>
                    <div class="loading-text">Connecting to Deriv...</div>
                </div>
                <canvas id="chart"></canvas>
            </div>
        </div>

        <div id="signals-tab" class="tab-content">
            <div class="grid">
                <div class="panel">
                    <div class="panel-title">ðŸ“Š MARKET DATA</div>
                    <div id="marketData">
                        <p style="text-align: center; color: var(--muted); padding: 20px;">Connecting to market...</p>
                    </div>
                </div>
                <div class="panel">
                    <div class="panel-title">âš¡ GENERATE SIGNAL</div>
                    <div id="signal">
                        <p style="text-align: center; color: var(--muted); padding: 40px 20px;">
                            Click "Generate Signal" to create a trading signal
                        </p>
                    </div>
                    <button class="btn-gen" onclick="generateSignal()">ðŸŽ¯ GENERATE SIGNAL</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        class DerivWebSocket {
            constructor() {
                this.ws = null;
                this.appId = 1089; // Demo app ID
                this.currentSymbol = 'R_100';
                this.candleData = [];
                this.tickSubscription = null;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 5;
            }

            connect() {
                return new Promise((resolve, reject) => {
                    this.updateStatus('connecting');
                    
                    this.ws = new WebSocket(`wss://ws.derivws.com/websockets/v3?app_id=${this.appId}`);
                    
                    this.ws.onopen = () => {
                        console.log('âœ“ Connected to Deriv');
                        this.reconnectAttempts = 0;
                        this.updateStatus('connected');
                        resolve();
                    };
                    
                    this.ws.onmessage = (msg) => {
                        const data = JSON.parse(msg.data);
                        this.handleMessage(data);
                    };
                    
                    this.ws.onerror = (error) => {
                        console.error('WebSocket error:', error);
                        this.updateStatus('disconnected');
                        reject(error);
                    };
                    
                    this.ws.onclose = () => {
                        console.log('Disconnected from Deriv');
                        this.updateStatus('disconnected');
                        this.attemptReconnect();
                    };
                });
            }

            attemptReconnect() {
                if (this.reconnectAttempts < this.maxReconnectAttempts) {
                    this.reconnectAttempts++;
                    console.log(`Reconnecting... (${this.reconnectAttempts}/${this.maxReconnectAttempts})`);
                    setTimeout(() => this.connect(), 2000 * this.reconnectAttempts);
                }
            }

            updateStatus(status) {
                const statusDot = document.getElementById('statusDot');
                const statusText = document.getElementById('status');
                
                statusDot.className = 'status-dot ' + status;
                
                switch(status) {
                    case 'connected':
                        statusText.textContent = 'ONLINE';
                        statusText.style.color = 'var(--accent)';
                        break;
                    case 'connecting':
                        statusText.textContent = 'CONNECTING...';
                        statusText.style.color = 'var(--warning)';
                        break;
                    case 'disconnected':
                        statusText.textContent = 'OFFLINE';
                        statusText.style.color = 'var(--danger)';
                        break;
                }
            }

            send(data) {
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify(data));
                }
            }

            async subscribeToCandles(symbol) {
                this.currentSymbol = symbol;
                
                // Unsubscribe from previous
                if (this.tickSubscription) {
                    this.send({ forget: this.tickSubscription });
                }

                // Get historical candles first
                await this.getHistoricalCandles(symbol);
                
                // Subscribe to live ticks
                this.send({
                    ticks: symbol,
                    subscribe: 1
                });
            }

            async getHistoricalCandles(symbol) {
                return new Promise((resolve) => {
                    const requestId = 'candles_' + Date.now();
                    
                    const handler = (data) => {
                        if (data.req_id === requestId && data.candles) {
                            this.candleData = data.candles.map(c => ({
                                time: new Date(c.epoch * 1000),
                                open: parseFloat(c.open),
                                high: parseFloat(c.high),
                                low: parseFloat(c.low),
                                close: parseFloat(c.close)
                            }));
                            
                            updateChart(this.candleData);
                            document.getElementById('loadingOverlay').classList.add('hidden');
                            resolve();
                        }
                    };
                    
                    this.messageHandlers.push(handler);
                    
                    this.send({
                        ticks_history: symbol,
                        adjust_start_time: 1,
                        count: 100,
                        end: 'latest',
                        start: Math.floor(Date.now() / 1000) - 3600 * 2, // 2 hours ago
                        style: 'candles',
                        granularity: 60, // 1-minute candles
                        req_id: requestId
                    });
                });
            }

            handleMessage(data) {
                // Handle tick updates
                if (data.tick) {
                    const tick = data.tick;
                    this.tickSubscription = data.subscription?.id;
                    
                    // Update current price
                    document.getElementById('price').textContent = `$${parseFloat(tick.quote).toFixed(2)}`;
                    
                    // Update last candle or create new one
                    this.updateCandleWithTick({
                        time: new Date(tick.epoch * 1000),
                        price: parseFloat(tick.quote)
                    });
                }
                
                // Handle candles history
                if (data.candles) {
                    // Already handled in getHistoricalCandles
                }
                
                // Call additional handlers
                this.messageHandlers.forEach(handler => handler(data));
            }

            updateCandleWithTick(tick) {
                if (this.candleData.length === 0) return;
                
                const lastCandle = this.candleData[this.candleData.length - 1];
                const tickMinute = Math.floor(tick.time.getTime() / 60000);
                const lastCandleMinute = Math.floor(lastCandle.time.getTime() / 60000);
                
                if (tickMinute === lastCandleMinute) {
                    // Update existing candle
                    lastCandle.close = tick.price;
                    lastCandle.high = Math.max(lastCandle.high, tick.price);
                    lastCandle.low = Math.min(lastCandle.low, tick.price);
                } else {
                    // Create new candle
                    const newCandle = {
                        time: new Date(tickMinute * 60000),
                        open: tick.price,
                        high: tick.price,
                        low: tick.price,
                        close: tick.price
                    };
                    this.candleData.push(newCandle);
                    
                    // Keep only last 100 candles
                    if (this.candleData.length > 100) {
                        this.candleData.shift();
                    }
                }
                
                updateChart(this.candleData);
            }
        }

        // Initialize
        const deriv = new DerivWebSocket();
        deriv.messageHandlers = [];
        let chartInstance;

        function initChart() {
            const ctx = document.getElementById('chart').getContext('2d');
            
            chartInstance = new Chart(ctx, {
                type: 'candlestick',
                data: {
                    datasets: [{
                        label: 'Price',
                        data: []
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'minute',
                                displayFormats: {
                                    minute: 'HH:mm'
                                }
                            },
                            grid: { color: '#1e2d4a' },
                            ticks: {
                                color: '#7a8aa5',
                                font: { family: 'JetBrains Mono', size: 10 }
                            }
                        },
                        y: {
                            grid: { color: '#1e2d4a' },
                            ticks: {
                                color: '#7a8aa5',
                                font: { family: 'JetBrains Mono', size: 10 }
                            }
                        }
                    }
                }
            });
        }

        function updateChart(candleData) {
            if (!chartInstance) return;
            
            chartInstance.data.datasets[0].data = candleData.map(c => ({
                x: c.time.getTime(),
                o: c.open,
                h: c.high,
                l: c.low,
                c: c.close
            }));
            
            chartInstance.update('none'); // Update without animation for smooth real-time
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }

        function generateSignal() {
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner" style="width: 20px; height: 20px; display: inline-block; margin-right: 10px;"></div> ANALYZING...';

            setTimeout(() => {
                if (deriv.candleData.length === 0) {
                    alert('No market data available. Please wait for data to load.');
                    btn.disabled = false;
                    btn.innerHTML = 'ðŸŽ¯ GENERATE SIGNAL';
                    return;
                }

                const lastCandle = deriv.candleData[deriv.candleData.length - 1];
                const currentPrice = lastCandle.close;
                
                // Simple trend analysis
                const recentCandles = deriv.candleData.slice(-10);
                const avgClose = recentCandles.reduce((sum, c) => sum + c.close, 0) / recentCandles.length;
                const direction = currentPrice > avgClose ? 'BUY' : 'SELL';
                
                const multiplier = 0.002;
                const base = currentPrice * multiplier;
                
                let entry, tp1, tp2, sl;
                if (direction === 'BUY') {
                    entry = currentPrice - (base * 0.1);
                    tp1 = entry + base;
                    tp2 = entry + (base * 2);
                    sl = entry - (base * 0.5);
                } else {
                    entry = currentPrice + (base * 0.1);
                    tp1 = entry - base;
                    tp2 = entry - (base * 2);
                    sl = entry + (base * 0.5);
                }
                
                const signal = {
                    symbol: deriv.currentSymbol,
                    direction,
                    entry: entry.toFixed(2),
                    tp1: tp1.toFixed(2),
                    tp2: tp2.toFixed(2),
                    sl: sl.toFixed(2),
                    currentPrice: currentPrice.toFixed(2)
                };
                
                displaySignal(signal);
                
                btn.disabled = false;
                btn.innerHTML = 'ðŸŽ¯ GENERATE SIGNAL';
            }, 1500);
        }

        function displaySignal(signal) {
            const html = `
                <div class="signal-box">
                    <div class="signal-row">
                        <span class="signal-label">SYMBOL</span>
                        <span class="signal-value">${signal.symbol}</span>
                    </div>
                    <div class="signal-row">
                        <span class="signal-label">PRICE</span>
                        <span class="signal-value">${signal.currentPrice}</span>
                    </div>
                    <div class="signal-row">
                        <span class="signal-label">DIRECTION</span>
                        <span class="signal-value ${signal.direction.toLowerCase()}">${signal.direction}</span>
                    </div>
                    <div class="signal-row">
                        <span class="signal-label">ENTRY</span>
                        <span class="signal-value">${signal.entry}</span>
                    </div>
                    <div class="signal-row">
                        <span class="signal-label">TP1</span>
                        <span class="signal-value">${signal.tp1}</span>
                    </div>
                    <div class="signal-row">
                        <span class="signal-label">TP2</span>
                        <span class="signal-value">${signal.tp2}</span>
                    </div>
                    <div class="signal-row">
                        <span class="signal-label">SL</span>
                        <span class="signal-value">${signal.sl}</span>
                    </div>
                </div>
            `;
            document.getElementById('signal').innerHTML = html;
        }

        // Event listeners for symbol buttons
        document.querySelectorAll('.index-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.index-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                const symbol = this.dataset.symbol;
                document.getElementById('idx').textContent = this.textContent;
                document.getElementById('loadingOverlay').classList.remove('hidden');
                
                deriv.subscribeToCandles(symbol);
            });
        });

        // Initialize on load
        window.addEventListener('load', async () => {
            initChart();
            
            try {
                await deriv.connect();
                await deriv.subscribeToCandles('R_100');
            } catch (error) {
                console.error('Failed to connect:', error);
                document.querySelector('.loading-text').textContent = 'Connection failed. Retrying...';
            }
        });
    </script>
</body>
</html>
