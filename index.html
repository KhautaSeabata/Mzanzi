<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMC Forex Analyzer Pro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: white;
            overflow-x: hidden;
            height: 100vh;
        }
        
        /* Auth Pages */
        .auth-page {
            display: none;
            min-height: 100vh;
            background: linear-gradient(135deg, #000 0%, #1a1a2e 100%);
            padding: 20px;
            overflow-y: auto;
        }
        .auth-page.active {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .auth-container {
            width: 100%;
            max-width: 400px;
            background: rgba(28, 28, 30, 0.95);
            border-radius: 20px;
            padding: 40px 30px;
            backdrop-filter: blur(20px);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        .auth-logo {
            text-align: center;
            margin-bottom: 30px;
        }
        .auth-logo-icon {
            font-size: 60px;
            margin-bottom: 10px;
        }
        .auth-logo-text {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #007AFF 0%, #5856D6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .auth-subtitle {
            text-align: center;
            color: #8E8E93;
            font-size: 14px;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-label {
            display: block;
            color: #8E8E93;
            font-size: 13px;
            margin-bottom: 8px;
            font-weight: 500;
        }
        .form-input {
            width: 100%;
            padding: 14px 16px;
            background: #2C2C2E;
            border: 1px solid transparent;
            border-radius: 12px;
            color: white;
            font-size: 15px;
            outline: none;
            transition: all 0.3s;
        }
        .form-input:focus {
            border-color: #007AFF;
            background: #1C1C1E;
        }
        .form-input::placeholder {
            color: #636366;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .auth-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #007AFF 0%, #5856D6 100%);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: transform 0.2s, opacity 0.2s;
        }
        .auth-btn:active {
            transform: scale(0.98);
        }
        .auth-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .auth-link {
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
            color: #8E8E93;
        }
        .auth-link a {
            color: #007AFF;
            text-decoration: none;
            font-weight: 600;
        }
        .message {
            padding: 12px;
            border-radius: 10px;
            font-size: 13px;
            margin-bottom: 20px;
            display: none;
        }
        .error-message {
            background: rgba(255, 69, 58, 0.1);
            border: 1px solid rgba(255, 69, 58, 0.3);
            color: #FF453A;
        }
        .success-message {
            background: rgba(48, 209, 88, 0.1);
            border: 1px solid rgba(48, 209, 88, 0.3);
            color: #30D158;
        }
        
        /* Main App */
        .app-container {
            display: none;
        }
        .app-container.active {
            display: block;
        }
        
        /* MT5 Header */
        .mt5-header {
            background: #1C1C1E;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #2C2C2E;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .mt5-logo {
            font-size: 18px;
            font-weight: 700;
            background: linear-gradient(135deg, #007AFF 0%, #5856D6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .account-info {
            display: flex;
            flex-direction: column;
        }
        .account-number {
            font-size: 10px;
            color: #8E8E93;
        }
        .account-balance {
            font-size: 13px;
            color: #30D158;
            font-weight: 600;
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .logout-btn {
            background: none;
            border: none;
            color: #FF453A;
            font-size: 12px;
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 6px;
            transition: background 0.2s;
        }
        .logout-btn:active {
            background: rgba(255, 69, 58, 0.1);
        }
        
        /* Bottom Navigation */
        .mt5-bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #1C1C1E;
            display: flex;
            justify-content: space-around;
            padding: 6px 0 calc(6px + env(safe-area-inset-bottom));
            border-top: 1px solid #2C2C2E;
            z-index: 1000;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            cursor: pointer;
            flex: 1;
            padding: 4px;
            color: #8E8E93;
            transition: color 0.2s;
        }
        .nav-item.active {
            color: #007AFF;
        }
        .nav-icon {
            font-size: 20px;
        }
        .nav-label {
            font-size: 9px;
            font-weight: 500;
        }
        
        /* Pages */
        .page-container {
            display: none;
            height: calc(100vh - 115px);
            overflow-y: auto;
        }
        .page-container.active {
            display: block;
        }
        
        /* Charts Page */
        .chart-toolbar {
            background: #1C1C1E;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            overflow-x: auto;
            border-bottom: 1px solid #2C2C2E;
        }
        .chart-toolbar::-webkit-scrollbar {
            display: none;
        }
        .toolbar-select {
            background: #2C2C2E;
            border: none;
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            outline: none;
        }
        .toolbar-btn {
            background: #2C2C2E;
            border: none;
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            cursor: pointer;
        }
        .toolbar-btn.active {
            background: #007AFF;
        }
        
        .chart-view {
            position: relative;
            height: calc(100vh - 235px);
            background: #000;
        }
        .single-chart {
            display: none;
            height: 100%;
            flex-direction: column;
        }
        .single-chart.active {
            display: flex;
        }
        
        .chart-info-bar {
            background: #1C1C1E;
            padding: 6px 12px;
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            border-bottom: 1px solid #2C2C2E;
        }
        .info-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .info-label {
            color: #8E8E93;
            font-size: 9px;
        }
        .info-value {
            font-weight: 600;
            font-size: 12px;
        }
        .info-value.green {
            color: #30D158;
        }
        .info-value.red {
            color: #FF453A;
        }
        
        .chart-canvas-container {
            flex: 1;
            position: relative;
            background: #000;
            overflow: hidden;
            touch-action: pan-x pan-y;
        }
        canvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        .zoom-controls {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 6px;
            z-index: 10;
        }
        .zoom-btn {
            width: 32px;
            height: 32px;
            border-radius: 16px;
            border: none;
            background: rgba(28, 28, 30, 0.9);
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            backdrop-filter: blur(10px);
        }
        
        .chart-tabs {
            background: #1C1C1E;
            display: flex;
            overflow-x: auto;
            border-top: 1px solid #2C2C2E;
            padding: 0 12px;
        }
        .chart-tabs::-webkit-scrollbar {
            display: none;
        }
        .chart-tab {
            padding: 10px 16px;
            cursor: pointer;
            color: #8E8E93;
            border-bottom: 2px solid transparent;
            white-space: nowrap;
            font-size: 12px;
            font-weight: 500;
        }
        .chart-tab.active {
            color: #007AFF;
            border-bottom-color: #007AFF;
        }
        
        /* Signals Page */
        .signals-header {
            background: #1C1C1E;
            padding: 12px 15px;
            border-bottom: 1px solid #2C2C2E;
        }
        .signals-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        .signals-controls {
            display: flex;
            gap: 8px;
        }
        .signal-filter-btn {
            padding: 5px 10px;
            background: #2C2C2E;
            border: none;
            color: white;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
        }
        .signal-filter-btn.active {
            background: #007AFF;
        }
        
        .signals-list {
            padding: 12px;
        }
        .no-signals {
            text-align: center;
            padding: 60px 20px;
            color: #8E8E93;
        }
        .no-signals-icon {
            font-size: 50px;
            margin-bottom: 12px;
        }
        
        .signal-card {
            background: #1C1C1E;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            border-left: 4px solid #007AFF;
        }
        .signal-card.bullish {
            border-left-color: #30D158;
        }
        .signal-card.bearish {
            border-left-color: #FF453A;
        }
        .signal-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }
        .signal-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .signal-symbol {
            font-size: 12px;
            color: #8E8E93;
        }
        .signal-badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 700;
        }
        .signal-badge.bullish {
            background: rgba(48, 209, 88, 0.2);
            color: #30D158;
        }
        .signal-badge.bearish {
            background: rgba(255, 69, 58, 0.2);
            color: #FF453A;
        }
        .signal-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 12px;
        }
        .signal-info-item {
            background: #2C2C2E;
            padding: 8px;
            border-radius: 8px;
        }
        .signal-info-label {
            font-size: 10px;
            color: #8E8E93;
            margin-bottom: 4px;
        }
        .signal-info-value {
            font-size: 14px;
            font-weight: 600;
        }
        .signal-time {
            font-size: 11px;
            color: #636366;
            margin-top: 10px;
        }
        
        /* Settings Page */
        .settings-section {
            background: #1C1C1E;
            margin: 12px;
            border-radius: 10px;
            overflow: hidden;
        }
        .settings-item {
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #2C2C2E;
        }
        .settings-item:last-child {
            border-bottom: none;
        }
        .settings-label {
            font-size: 14px;
        }
        .toggle-switch {
            width: 45px;
            height: 26px;
            background: #2C2C2E;
            border-radius: 13px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
        }
        .toggle-switch.active {
            background: #30D158;
        }
        .toggle-thumb {
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 11px;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: left 0.3s;
        }
        .toggle-switch.active .toggle-thumb {
            left: 21px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 3px;
            margin-right: 5px;
        }
        .status-connected {
            background: #30D158;
        }
        .status-disconnected {
            background: #FF453A;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #8E8E93;
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div class="auth-page active" id="loginPage">
        <div class="auth-container">
            <div class="auth-logo">
                <div class="auth-logo-icon">üìà</div>
                <div class="auth-logo-text">FOREX PRO</div>
            </div>
            <div class="auth-subtitle">Smart Market Concepts Trading</div>
            <div class="message error-message" id="loginError"></div>
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" placeholder="your@email.com" required id="loginEmail">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" placeholder="Enter your password" required id="loginPassword">
                </div>
                <button type="submit" class="auth-btn">Sign In</button>
            </form>
            <div class="auth-link">
                <a href="#" id="forgotLink">Forgot Password?</a>
            </div>
            <div class="auth-link">
                Don't have an account? <a href="#" id="signupLink">Sign Up</a>
            </div>
        </div>
    </div>

    <!-- Register Page -->
    <div class="auth-page" id="registerPage">
        <div class="auth-container">
            <div class="auth-logo">
                <div class="auth-logo-icon">üìà</div>
                <div class="auth-logo-text">FOREX PRO</div>
            </div>
            <div class="auth-subtitle">Create Your Trading Account</div>
            <div class="message error-message" id="registerError"></div>
            <div class="message success-message" id="registerSuccess"></div>
            <form id="registerForm">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">First Name</label>
                        <input type="text" class="form-input" placeholder="John" required id="regFirstName">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Last Name</label>
                        <input type="text" class="form-input" placeholder="Doe" required id="regLastName">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" placeholder="your@email.com" required id="regEmail">
                </div>
                <div class="form-group">
                    <label class="form-label">Phone Number</label>
                    <input type="tel" class="form-input" placeholder="+1234567890" required id="regPhone">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" placeholder="Min 8 characters" required id="regPassword" minlength="8">
                </div>
                <div class="form-group">
                    <label class="form-label">Confirm Password</label>
                    <input type="password" class="form-input" placeholder="Re-enter password" required id="regConfirmPassword" minlength="8">
                </div>
                <button type="submit" class="auth-btn">Create Account</button>
            </form>
            <div class="auth-link">
                Already have an account? <a href="#" id="loginLink">Sign In</a>
            </div>
        </div>
    </div>

    <!-- Forgot Password Page -->
    <div class="auth-page" id="forgotPage">
        <div class="auth-container">
            <div class="auth-logo">
                <div class="auth-logo-icon">üîê</div>
                <div class="auth-logo-text">Reset Password</div>
            </div>
            <div class="auth-subtitle">Enter your email to reset your password</div>
            <div class="message error-message" id="forgotError"></div>
            <div class="message success-message" id="forgotSuccess"></div>
            <form id="forgotForm">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" placeholder="your@email.com" required id="forgotEmail">
                </div>
                <div id="resetFields" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">New Password</label>
                        <input type="password" class="form-input" placeholder="Min 8 characters" id="forgotNewPassword" minlength="8">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Confirm New Password</label>
                        <input type="password" class="form-input" placeholder="Re-enter password" id="forgotConfirmPassword" minlength="8">
                    </div>
                </div>
                <button type="submit" class="auth-btn" id="forgotBtn">Continue</button>
            </form>
            <div class="auth-link">
                <a href="#" id="backToLoginLink">Back to Sign In</a>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div class="app-container" id="appContainer">
        <!-- Header -->
        <div class="mt5-header">
            <div class="header-left">
                <div class="mt5-logo">FOREX PRO</div>
                <div class="account-info">
                    <div class="account-number" id="userNameDisplay">User</div>
                    <div class="account-balance">$10,000.00</div>
                </div>
            </div>
            <div class="header-right">
                <span class="status-indicator status-disconnected" id="connectionStatus"></span>
                <button class="logout-btn" id="logoutBtn">Logout</button>
            </div>
        </div>

        <!-- Charts Page -->
        <div class="page-container active" id="chartsPage">
            <div class="chart-toolbar">
                <select class="toolbar-select" id="numCharts">
                    <option value="1" selected>1 Chart</option>
                    <option value="2">2 Charts</option>
                    <option value="3">3 Charts</option>
                    <option value="4">4 Charts</option>
                </select>
                <button class="toolbar-btn" id="startBtn">‚ñ∂</button>
                <button class="toolbar-btn" id="stopBtn">‚è∏</button>
                <button class="toolbar-btn" id="refreshBtn">üîÑ</button>
                <button class="toolbar-btn active" id="analysisToggle">SMC</button>
            </div>

            <div class="chart-view">
                <div class="single-chart active" id="chart1">
                    <div class="chart-info-bar">
                        <div class="info-item">
                            <div class="info-label">Pair</div>
                            <div class="info-value" id="symbolName1">US 100</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Price</div>
                            <div class="info-value" id="price1">--</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Change</div>
                            <div class="info-value" id="change1">--</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">H/L</div>
                            <div class="info-value" id="highlow1">--</div>
                        </div>
                    </div>
                    <div class="chart-toolbar">
                        <select class="toolbar-select" id="symbol1">
                            <option value="US100" selected>US 100</option>
                            <option value="XAUUSD">GOLD</option>
                            <option value="EURUSD">EUR/USD</option>
                            <option value="GBPUSD">GBP/USD</option>
                        </select>
                        <select class="toolbar-select" id="timeframe1">
                            <option value="300" selected>5M</option>
                            <option value="900">15M</option>
                            <option value="1800">30M</option>
                            <option value="3600">1H</option>
                        </select>
                    </div>
                    <div class="chart-canvas-container">
                        <canvas id="canvas1"></canvas>
                        <div class="zoom-controls">
                            <button class="zoom-btn" onclick="zoom(1, 'in')">+</button>
                            <button class="zoom-btn" onclick="zoom(1, 'out')">‚àí</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="chart-tabs" id="chartTabs">
                <div class="chart-tab active">Chart 1</div>
            </div>
        </div>

        <!-- Signals Page -->
        <div class="page-container" id="signalsPage">
            <div class="signals-header">
                <div class="signals-title">SMC Signals</div>
                <div class="signals-controls">
                    <button class="signal-filter-btn active" onclick="filterSignals('all')">All</button>
                    <button class="signal-filter-btn" onclick="filterSignals('bullish')">Bullish</button>
                    <button class="signal-filter-btn" onclick="filterSignals('bearish')">Bearish</button>
                </div>
            </div>
            <div class="signals-list" id="signalsList">
                <div class="no-signals">
                    <div class="no-signals-icon">üìä</div>
                    <div>No signals detected yet</div>
                    <div style="font-size: 12px; margin-top: 8px;">Start charts to detect SMC patterns</div>
                </div>
            </div>
        </div>

        <!-- Settings Page -->
        <div class="page-container" id="settingsPage">
            <div class="settings-section">
                <div class="settings-item">
                    <div class="settings-label">SMC Analysis</div>
                    <div class="toggle-switch active" onclick="toggleSetting(this, 'smc')">
                        <div class="toggle-thumb"></div>
                    </div>
                </div>
                <div class="settings-item">
                    <div class="settings-label">Show Order Blocks</div>
                    <div class="toggle-switch active" onclick="toggleSetting(this, 'ob')">
                        <div class="toggle-thumb"></div>
                    </div>
                </div>
                <div class="settings-item">
                    <div class="settings-label">Show FVG</div>
                    <div class="toggle-switch active" onclick="toggleSetting(this, 'fvg')">
                        <div class="toggle-thumb"></div>
                    </div>
                </div>
                <div class="settings-item">
                    <div class="settings-label">Sound Alerts</div>
                    <div class="toggle-switch active" onclick="toggleSetting(this, 'sound')">
                        <div class="toggle-thumb"></div>
                    </div>
                </div>
            </div>
            <div class="settings-section" style="margin-top: 20px;">
                <div class="settings-item">
                    <div class="settings-label">Clear All Signals</div>
                    <button class="auth-btn" onclick="clearAllSignals()" style="width: auto; padding: 8px 16px; margin: 0; font-size: 12px;">Clear</button>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="mt5-bottom-nav">
            <div class="nav-item active" data-page="chartsPage">
                <div class="nav-icon">üìà</div>
                <div class="nav-label">Charts</div>
            </div>
            <div class="nav-item" data-page="signalsPage">
                <div class="nav-icon">üéØ</div>
                <div class="nav-label">Signals</div>
            </div>
            <div class="nav-item" data-page="settingsPage">
                <div class="nav-icon">‚öôÔ∏è</div>
                <div class="nav-label">Settings</div>
            </div>
        </div>
    </div>

    <script>
        // ============ FIREBASE CONFIGURATION ============
        const FIREBASE_URL = 'https://mzanzifx-default-rtdb.firebaseio.com';
        
        // ============ AUTHENTICATION SYSTEM ============
        let currentUser = null;
        let forgotStep = 1;
        
        // Firebase User Management
        async function saveUserToFirebase(email, userData) {
            try {
                const safeEmail = email.replace(/\./g, '_').replace(/[@#$\[\]]/g, '_');
                const response = await fetch(`${FIREBASE_URL}/users/${safeEmail}.json`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });
                return response.ok;
            } catch (e) {
                console.error('Error saving user:', e);
                return false;
            }
        }
        
        async function getUserFromFirebase(email) {
            try {
                const safeEmail = email.replace(/\./g, '_').replace(/[@#$\[\]]/g, '_');
                const response = await fetch(`${FIREBASE_URL}/users/${safeEmail}.json`);
                return await response.json();
            } catch (e) {
                console.error('Error getting user:', e);
                return null;
            }
        }
        
        // UI Helper Functions
        function showPage(pageId) {
            document.querySelectorAll('.auth-page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            hideMessages();
        }
        
        function showMessage(id, text) {
            const el = document.getElementById(id);
            el.textContent = text;
            el.style.display = 'block';
        }
        
        function hideMessages() {
            document.querySelectorAll('.message').forEach(m => m.style.display = 'none');
        }
        
        // Registration Handler
        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            hideMessages();
            
            const submitBtn = this.querySelector('.auth-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Creating Account...';
            
            const firstName = document.getElementById('regFirstName').value.trim();
            const lastName = document.getElementById('regLastName').value.trim();
            const email = document.getElementById('regEmail').value.trim().toLowerCase();
            const phone = document.getElementById('regPhone').value.trim();
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('regConfirmPassword').value;
            
            if (password !== confirmPassword) {
                showMessage('registerError', 'Passwords do not match!');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Create Account';
                return;
            }
            
            if (password.length < 8) {
                showMessage('registerError', 'Password must be at least 8 characters!');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Create Account';
                return;
            }
            
            const existingUser = await getUserFromFirebase(email);
            if (existingUser) {
                showMessage('registerError', 'Email already registered!');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Create Account';
                return;
            }
            
            const userData = {
                firstName,
                lastName,
                email,
                phone,
                password,
                createdAt: Date.now(),
                balance: 10000
            };
            
            const saved = await saveUserToFirebase(email, userData);
            
            if (saved) {
                showMessage('registerSuccess', 'Account created successfully! Redirecting...');
                setTimeout(() => {
                    this.reset();
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Create Account';
                    showPage('loginPage');
                }, 2000);
            } else {
                showMessage('registerError', 'Error creating account. Please try again.');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Create Account';
            }
        });
        
        // Login Handler
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            hideMessages();
            
            const submitBtn = this.querySelector('.auth-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Signing In...';
            
            const email = document.getElementById('loginEmail').value.trim().toLowerCase();
            const password = document.getElementById('loginPassword').value;
            
            const user = await getUserFromFirebase(email);
            
            if (!user) {
                showMessage('loginError', 'Email not found!');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Sign In';
                return;
            }
            
            if (user.password !== password) {
                showMessage('loginError', 'Incorrect password!');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Sign In';
                return;
            }
            
            currentUser = user;
            document.getElementById('userNameDisplay').textContent = `${currentUser.firstName} ${currentUser.lastName}`;
            document.getElementById('appContainer').querySelector('.account-balance').textContent = 
                `${currentUser.balance ? currentUser.balance.toLocaleString() : '10,000'}.00`;
            
            document.querySelectorAll('.auth-page').forEach(p => p.classList.remove('active'));
            document.getElementById('appContainer').classList.add('active');
            
            submitBtn.disabled = false;
            submitBtn.textContent = 'Sign In';
            
            // Load user signals and initialize charts
            setTimeout(() => {
                initializeCharts();
                loadSignalsFromFirebase();
            }, 300);
        });
        
        // Forgot Password Handler
        document.getElementById('forgotForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            hideMessages();
            
            const submitBtn = document.getElementById('forgotBtn');
            submitBtn.disabled = true;
            
            const email = document.getElementById('forgotEmail').value.trim().toLowerCase();
            
            if (forgotStep === 1) {
                submitBtn.textContent = 'Verifying...';
                const user = await getUserFromFirebase(email);
                
                if (!user) {
                    showMessage('forgotError', 'Email not found!');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Continue';
                    return;
                }
                
                document.getElementById('resetFields').style.display = 'block';
                submitBtn.textContent = 'Reset Password';
                showMessage('forgotSuccess', 'Email verified! Enter new password.');
                forgotStep = 2;
                submitBtn.disabled = false;
            } else {
                submitBtn.textContent = 'Resetting...';
                const newPassword = document.getElementById('forgotNewPassword').value;
                const confirmPassword = document.getElementById('forgotConfirmPassword').value;
                
                if (newPassword !== confirmPassword) {
                    showMessage('forgotError', 'Passwords do not match!');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Reset Password';
                    return;
                }
                
                if (newPassword.length < 8) {
                    showMessage('forgotError', 'Password must be at least 8 characters!');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Reset Password';
                    return;
                }
                
                const user = await getUserFromFirebase(email);
                user.password = newPassword;
                await saveUserToFirebase(email, user);
                
                showMessage('forgotSuccess', 'Password reset successfully! Redirecting...');
                
                setTimeout(() => {
                    this.reset();
                    document.getElementById('resetFields').style.display = 'none';
                    submitBtn.textContent = 'Continue';
                    forgotStep = 1;
                    submitBtn.disabled = false;
                    showPage('loginPage');
                }, 2000);
            }
        });
        
        // Navigation Links
        document.getElementById('signupLink').addEventListener('click', (e) => {
            e.preventDefault();
            showPage('registerPage');
        });
        
        document.getElementById('loginLink').addEventListener('click', (e) => {
            e.preventDefault();
            showPage('loginPage');
        });
        
        document.getElementById('forgotLink').addEventListener('click', (e) => {
            e.preventDefault();
            showPage('forgotPage');
        });
        
        document.getElementById('backToLoginLink').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('forgotForm').reset();
            document.getElementById('resetFields').style.display = 'none';
            document.getElementById('forgotBtn').textContent = 'Continue';
            forgotStep = 1;
            showPage('loginPage');
        });
        
        // Logout Handler
        document.getElementById('logoutBtn').addEventListener('click', function() {
            if (confirm('Are you sure you want to logout?')) {
                stopAllCharts();
                currentUser = null;
                document.getElementById('appContainer').classList.remove('active');
                showPage('loginPage');
                document.getElementById('loginForm').reset();
            }
        });
        
        // ============ CHART SYSTEM ============
        const SYMBOL_CONFIG = {
            'US100': { name: 'US 100', base: 21500, apiSymbol: 'US100' },
            'XAUUSD': { name: 'GOLD', base: 2650, apiSymbol: 'frxXAUUSD' },
            'EURUSD': { name: 'EUR/USD', base: 1.0850, apiSymbol: 'frxEURUSD' },
            'GBPUSD': { name: 'GBP/USD', base: 1.2650, apiSymbol: 'frxGBPUSD' }
        };
        
        let charts = {};
        let analysisEnabled = true;
        let allSignals = [];
        let signalFilter = 'all';
        
        class ChartManager {
            constructor(id) {
                this.id = id;
                this.canvas = document.getElementById(`canvas${id}`);
                this.ctx = this.canvas.getContext('2d');
                this.data = [];
                this.symbol = 'US100';
                this.timeframe = 300;
                this.zoom = 80;
                this.running = false;
                this.lastSignalTime = 0;
                
                this.resizeCanvas();
                this.startSimulation();
            }
            
            resizeCanvas() {
                const container = this.canvas.parentElement;
                this.canvas.width = container.clientWidth;
                this.canvas.height = container.clientHeight;
            }
            
            startSimulation() {
                this.running = true;
                const config = SYMBOL_CONFIG[this.symbol];
                let price = config.base;
                
                const now = Date.now();
                for (let i = 100; i >= 0; i--) {
                    const time = now - (i * this.timeframe * 1000);
                    const volatility = price * 0.002;
                    const change = (Math.random() - 0.48) * volatility;
                    const open = price;
                    price += change;
                    const high = Math.max(open, price) + Math.random() * volatility * 0.5;
                    const low = Math.min(open, price) - Math.random() * volatility * 0.5;
                    
                    this.data.push({
                        x: time,
                        o: open,
                        h: high,
                        l: low,
                        c: price
                    });
                }
                
                this.draw();
                this.updateInfo();
                
                this.interval = setInterval(() => {
                    if (this.running) {
                        const last = this.data[this.data.length - 1];
                        const volatility = last.c * 0.002;
                        const change = (Math.random() - 0.48) * volatility;
                        const newPrice = last.c + change;
                        
                        const now = Date.now();
                        const candleStart = Math.floor(now / (this.timeframe * 1000)) * (this.timeframe * 1000);
                        
                        if (candleStart > last.x) {
                            this.data.push({
                                x: candleStart,
                                o: last.c,
                                h: Math.max(last.c, newPrice),
                                l: Math.min(last.c, newPrice),
                                c: newPrice
                            });
                            if (this.data.length > 200) this.data.shift();
                            
                            // Generate SMC signal randomly
                            if (analysisEnabled && Math.random() > 0.95) {
                                this.generateSignal();
                            }
                        } else {
                            last.c = newPrice;
                            last.h = Math.max(last.h, newPrice);
                            last.l = Math.min(last.l, newPrice);
                        }
                        
                        this.draw();
                        this.updateInfo();
                    }
                }, 2000);
            }
            
            generateSignal() {
                const now = Date.now();
                if (now - this.lastSignalTime < 300000) return; // 5 min cooldown
                
                const patterns = [
                    'Bullish Order Block',
                    'Bearish Order Block',
                    'Bullish FVG',
                    'Bearish FVG',
                    'Bullish BOS',
                    'Bearish BOS',
                    'Bullish CHoCH',
                    'Bearish CHoCH'
                ];
                
                const pattern = patterns[Math.floor(Math.random() * patterns.length)];
                const bias = pattern.includes('Bullish') ? 'bullish' : 'bearish';
                const current = this.data[this.data.length - 1];
                const atr = this.calculateATR();
                
                let entry = current.c;
                let tp1, tp2, tp3, sl;
                
                if (bias === 'bullish') {
                    tp1 = entry + (atr * 1.5);
                    tp2 = entry + (atr * 2.5);
                    tp3 = entry + (atr * 3.5);
                    sl = entry - (atr * 1.0);
                } else {
                    tp1 = entry - (atr * 1.5);
                    tp2 = entry - (atr * 2.5);
                    tp3 = entry - (atr * 3.5);
                    sl = entry + (atr * 1.0);
                }
                
                const rr = Math.abs((tp1 - entry) / (entry - sl));
                const confidence = Math.floor(60 + Math.random() * 30);
                
                const signal = {
                    id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    name: pattern,
                    bias: bias,
                    symbol: SYMBOL_CONFIG[this.symbol].name,
                    timeframe: this.getTimeframeLabel(),
                    entry: entry.toFixed(2),
                    tp1: tp1.toFixed(2),
                    tp2: tp2.toFixed(2),
                    tp3: tp3.toFixed(2),
                    sl: sl.toFixed(2),
                    rr: rr.toFixed(2),
                    confidence: confidence,
                    timestamp: Date.now(),
                    userId: currentUser ? currentUser.email : 'guest'
                };
                
                this.lastSignalTime = now;
                addSignal(signal);
            }
            
            calculateATR() {
                if (this.data.length < 15) return 0.01;
                
                let atrSum = 0;
                for (let i = this.data.length - 14; i < this.data.length; i++) {
                    const current = this.data[i];
                    const prev = this.data[i - 1];
                    const tr = Math.max(
                        current.h - current.l,
                        Math.abs(current.h - prev.c),
                        Math.abs(current.l - prev.c)
                    );
                    atrSum += tr;
                }
                
                return atrSum / 14;
            }
            
            getTimeframeLabel() {
                const labels = {
                    300: '5M',
                    900: '15M',
                    1800: '30M',
                    3600: '1H'
                };
                return labels[this.timeframe] || '5M';
            }
            
            draw() {
                if (!this.data.length) return;
                
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                const padding = { top: 20, right: 60, bottom: 20, left: 10 };
                const chartW = this.canvas.width - padding.left - padding.right;
                const chartH = this.canvas.height - padding.top - padding.bottom;
                
                const visible = this.data.slice(-this.zoom);
                if (!visible.length) return;
                
                const prices = visible.flatMap(c => [c.h, c.l]);
                const maxP = Math.max(...prices);
                const minP = Math.min(...prices);
                const range = maxP - minP;
                const pad = range * 0.1;
                
                const candleW = Math.max(2, Math.min(12, chartW / visible.length - 2));
                const spacing = chartW / visible.length;
                
                const priceToY = (price) => {
                    return padding.top + ((maxP + pad - price) / (range + pad * 2)) * chartH;
                };
                
                // Draw grid
                this.ctx.strokeStyle = '#2C2C2E';
                this.ctx.lineWidth = 1;
                for (let i = 0; i <= 4; i++) {
                    const y = padding.top + (chartH / 4) * i;
                    this.ctx.beginPath();
                    this.ctx.moveTo(padding.left, y);
                    this.ctx.lineTo(this.canvas.width - padding.right, y);
                    this.ctx.stroke();
                }
                
                // Draw candles
                visible.forEach((c, i) => {
                    const x = padding.left + spacing * i + spacing / 2;
                    const yH = priceToY(c.h);
                    const yL = priceToY(c.l);
                    const yO = priceToY(c.o);
                    const yC = priceToY(c.c);
                    
                    const isUp = c.c >= c.o;
                    const color = isUp ? '#30D158' : '#FF453A';
                    
                    this.ctx.strokeStyle = color;
                    this.ctx.lineWidth = Math.max(1, candleW / 4);
                    this.ctx.beginPath();
                    this.ctx.moveTo(x, yH);
                    this.ctx.lineTo(x, yL);
                    this.ctx.stroke();
                    
                    this.ctx.fillStyle = color;
                    const bodyH = Math.max(Math.abs(yC - yO), 1);
                    this.ctx.fillRect(x - candleW / 2, Math.min(yO, yC), candleW, bodyH);
                });
                
                // Draw price scale
                this.ctx.fillStyle = '#8E8E93';
                this.ctx.font = '10px -apple-system';
                this.ctx.textAlign = 'left';
                for (let i = 0; i <= 4; i++) {
                    const price = maxP + pad - (range + pad * 2) * (i / 4);
                    const y = padding.top + (chartH / 4) * i;
                    this.ctx.fillText(price.toFixed(2), this.canvas.width - padding.right + 5, y + 3);
                }
            }
            
            updateInfo() {
                if (!this.data.length) return;
                
                const current = this.data[this.data.length - 1];
                const first = this.data[0];
                const change = current.c - first.o;
                const changePercent = (change / first.o) * 100;
                
                const prices = this.data.flatMap(c => [c.h, c.l]);
                const high = Math.max(...prices);
                const low = Math.min(...prices);
                
                document.getElementById(`price${this.id}`).textContent = current.c.toFixed(2);
                
                const changeEl = document.getElementById(`change${this.id}`);
                changeEl.textContent = `${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%`;
                changeEl.className = `info-value ${changePercent >= 0 ? 'green' : 'red'}`;
                
                document.getElementById(`highlow${this.id}`).textContent = 
                    `${high.toFixed(2)}/${low.toFixed(2)}`;
            }
            
            stop() {
                this.running = false;
                if (this.interval) clearInterval(this.interval);
            }
        }
        
        function initializeCharts() {
            charts[1] = new ChartManager(1);
            document.getElementById('connectionStatus').className = 'status-indicator status-connected';
        }
        
        function startAllCharts() {
            if (!charts[1]) initializeCharts();
            charts[1].running = true;
            document.getElementById('connectionStatus').className = 'status-indicator status-connected';
        }
        
        function stopAllCharts() {
            if (charts[1]) charts[1].stop();
            document.getElementById('connectionStatus').className = 'status-indicator status-disconnected';
        }
        
        function zoom(id, dir) {
            const chart = charts[id];
            if (!chart) return;
            if (dir === 'in') {
                chart.zoom = Math.max(20, chart.zoom - 10);
            } else {
                chart.zoom = Math.min(150, chart.zoom + 10);
            }
            chart.draw();
        }
        
        // ============ SIGNAL MANAGEMENT ============
        
        async function addSignal(signal) {
            const exists = allSignals.find(s => 
                s.name === signal.name && 
                s.bias === signal.bias &&
                Date.now() - s.timestamp < 300000
            );
            
            if (exists) return;
            
            allSignals.unshift(signal);
            allSignals = allSignals.slice(0, 50);
            
            await saveSignalToFirebase(signal);
            displaySignals();
            
            if (signal.confidence >= 70) {
                playSound();
            }
        }
        
        async function saveSignalToFirebase(signal) {
            if (!currentUser) return;
            
            try {
                await fetch(`${FIREBASE_URL}/signals/${signal.id}.json`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(signal)
                });
            } catch (e) {
                console.error('Error saving signal:', e);
            }
        }
        
        async function loadSignalsFromFirebase() {
            if (!currentUser) return;
            
            try {
                const response = await fetch(`${FIREBASE_URL}/signals.json`);
                const data = await response.json();
                
                if (data) {
                    allSignals = Object.values(data)
                        .filter(s => s.userId === currentUser.email)
                        .sort((a, b) => b.timestamp - a.timestamp)
                        .slice(0, 50);
                    displaySignals();
                }
            } catch (e) {
                console.error('Error loading signals:', e);
            }
        }
        
        function displaySignals() {
            const container = document.getElementById('signalsList');
            
            let filtered = allSignals;
            if (signalFilter !== 'all') {
                filtered = allSignals.filter(s => s.bias === signalFilter);
            }
            
            if (!filtered.length) {
                container.innerHTML = `
                    <div class="no-signals">
                        <div class="no-signals-icon">üìä</div>
                        <div>No ${signalFilter === 'all' ? '' : signalFilter} signals detected yet</div>
                        <div style="font-size: 12px; margin-top: 8px;">Start charts to detect SMC patterns</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filtered.map(s => {
                const timeAgo = getTimeAgo(s.timestamp);
                
                return `
                    <div class="signal-card ${s.bias}">
                        <div class="signal-header">
                            <div>
                                <div class="signal-name">${s.name}</div>
                                <div class="signal-symbol">${s.symbol} ‚Ä¢ ${s.timeframe}</div>
                            </div>
                            <div class="signal-badge ${s.bias}">${s.bias.toUpperCase()}</div>
                        </div>
                        <div class="signal-info">
                            <div class="signal-info-item">
                                <div class="signal-info-label">Entry</div>
                                <div class="signal-info-value">${s.entry}</div>
                            </div>
                            <div class="signal-info-item">
                                <div class="signal-info-label">TP1</div>
                                <div class="signal-info-value" style="color: #30D158">${s.tp1}</div>
                            </div>
                            <div class="signal-info-item">
                                <div class="signal-info-label">TP2</div>
                                <div class="signal-info-value" style="color: #30D158">${s.tp2}</div>
                            </div>
                            <div class="signal-info-item">
                                <div class="signal-info-label">TP3</div>
                                <div class="signal-info-value" style="color: #30D158">${s.tp3}</div>
                            </div>
                            <div class="signal-info-item">
                                <div class="signal-info-label">Stop Loss</div>
                                <div class="signal-info-value" style="color: #FF453A">${s.sl}</div>
                            </div>
                            <div class="signal-info-item">
                                <div class="signal-info-label">R:R</div>
                                <div class="signal-info-value">1:${s.rr}</div>
                            </div>
                        </div>
                        <div class="signal-time">${timeAgo} ‚Ä¢ Confidence: ${s.confidence}%</div>
                    </div>
                `;
            }).join('');
        }
        
        function filterSignals(type) {
            signalFilter = type;
            
            document.querySelectorAll('.signal-filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if ((type === 'all' && btn.textContent === 'All') ||
                    (type === 'bullish' && btn.textContent === 'Bullish') ||
                    (type === 'bearish' && btn.textContent === 'Bearish')) {
                    btn.classList.add('active');
                }
            });
            
            displaySignals();
        }
        
        async function clearAllSignals() {
            if (!confirm('Clear all signals from database?')) return;
            
            try {
                if (currentUser) {
                    // Delete only user's signals
                    for (const signal of allSignals) {
                        await fetch(`${FIREBASE_URL}/signals/${signal.id}.json`, {
                            method: 'DELETE'
                        });
                    }
                }
                allSignals = [];
                displaySignals();
            } catch (e) {
                console.error('Error clearing signals:', e);
            }
        }
        
        function getTimeAgo(timestamp) {
            const seconds = Math.floor((Date.now() - timestamp) / 1000);
            
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            return `${Math.floor(seconds / 86400)}d ago`;
        }
        
        function toggleSetting(el, setting) {
            el.classList.toggle('active');
            
            if (setting === 'smc') {
                analysisEnabled = !analysisEnabled;
                const btn = document.getElementById('analysisToggle');
                btn.classList.toggle('active', analysisEnabled);
            }
        }
        
        function playSound() {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                
                osc.connect(gain);
                gain.connect(ctx.destination);
                
                osc.frequency.value = 880;
                osc.type = 'sine';
                
                gain.gain.setValueAtTime(0.3, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                
                osc.start(ctx.currentTime);
                osc.stop(ctx.currentTime + 0.3);
            } catch (e) {
                console.error('Audio error:', e);
            }
        }
        
        // ============ UI CONTROLS ============
        
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function() {
                const pageId = this.getAttribute('data-page');
                document.querySelectorAll('.page-container').forEach(p => p.classList.remove('active'));
                document.getElementById(pageId).classList.add('active');
                document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                this.classList.add('active');
                
                if (pageId === 'signalsPage') {
                    loadSignalsFromFirebase();
                }
            });
        });
        
        document.getElementById('startBtn').addEventListener('click', startAllCharts);
        document.getElementById('stopBtn').addEventListener('click', stopAllCharts);
        document.getElementById('refreshBtn').addEventListener('click', function() {
            stopAllCharts();
            setTimeout(startAllCharts, 500);
        });
        
        document.getElementById('analysisToggle').addEventListener('click', function() {
            analysisEnabled = !analysisEnabled;
            this.classList.toggle('active');
        });
        
        window.addEventListener('resize', () => {
            if (charts[1]) {
                charts[1].resizeCanvas();
                charts[1].draw();
            }
        });
    </script>
</body>
</html>
